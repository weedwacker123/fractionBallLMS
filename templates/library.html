{% extends 'base.html' %}

{% block title %}Content Library - Fraction Ball LMS{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-secondary-900 mb-2">Content Library</h1>
        <p class="text-secondary-600">Discover and explore educational content from your school</p>
    </div>
    
    <!-- Search and Filters -->
    <div class="bg-white rounded-lg shadow-sm border border-secondary-200 p-6 mb-6">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
            <!-- Search -->
            <div class="lg:col-span-2">
                <label for="search" class="form-label">Search Content</label>
                <input 
                    type="text" 
                    id="search" 
                    placeholder="Search videos and resources..." 
                    class="form-input"
                    hx-get="/api/library/videos/"
                    hx-trigger="keyup changed delay:500ms"
                    hx-target="#content-grid"
                    hx-include="[name='filters']"
                >
            </div>
            
            <!-- Content Type -->
            <div>
                <label for="content-type" class="form-label">Content Type</label>
                <select id="content-type" name="content-type" class="form-input" onchange="filterContent()">
                    <option value="videos">Videos</option>
                    <option value="resources">Resources</option>
                    <option value="playlists">Playlists</option>
                </select>
            </div>
            
            <!-- Quick Filters -->
            <div>
                <label class="form-label">Quick Filters</label>
                <div class="flex flex-wrap gap-2">
                    <button class="btn btn-secondary text-xs" onclick="clearFilters()">Clear All</button>
                    <button class="btn btn-secondary text-xs" onclick="applyFilter('recent')">Recent</button>
                    <button class="btn btn-secondary text-xs" onclick="applyFilter('popular')">Popular</button>
                </div>
            </div>
        </div>
        
        <!-- Advanced Filters -->
        <div id="advanced-filters" class="mt-4 pt-4 border-t border-secondary-200 hidden">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="grade-filter" class="form-label">Grade Level</label>
                    <select id="grade-filter" name="grade" class="form-input" onchange="filterContent()">
                        <option value="">All Grades</option>
                        <option value="K">Kindergarten</option>
                        <option value="1">Grade 1</option>
                        <option value="2">Grade 2</option>
                        <option value="3">Grade 3</option>
                        <option value="4">Grade 4</option>
                        <option value="5">Grade 5</option>
                        <option value="6">Grade 6</option>
                        <option value="7">Grade 7</option>
                        <option value="8">Grade 8</option>
                    </select>
                </div>
                
                <div>
                    <label for="topic-filter" class="form-label">Topic</label>
                    <select id="topic-filter" name="topic" class="form-input" onchange="filterContent()">
                        <option value="">All Topics</option>
                        <option value="fractions_basics">Fractions Basics</option>
                        <option value="equivalent_fractions">Equivalent Fractions</option>
                        <option value="comparing_ordering">Comparing/Ordering</option>
                        <option value="number_line">Number Line</option>
                        <option value="mixed_improper">Mixed ↔ Improper</option>
                        <option value="add_subtract_fractions">Add/Subtract Fractions</option>
                        <option value="multiply_divide_fractions">Multiply/Divide Fractions (6+)</option>
                        <option value="decimals_percents">Decimals & Percents</option>
                        <option value="ratio_proportion">Ratio/Proportion (6+)</option>
                        <option value="word_problems">Word Problems</option>
                    </select>
                </div>
                
                <div>
                    <label for="owner-filter" class="form-label">Created By</label>
                    <select id="owner-filter" name="owner" class="form-input" onchange="filterContent()">
                        <option value="">All Teachers</option>
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
                
                <div>
                    <label for="sort-filter" class="form-label">Sort By</label>
                    <select id="sort-filter" name="ordering" class="form-input" onchange="filterContent()">
                        <option value="-created_at">Newest First</option>
                        <option value="created_at">Oldest First</option>
                        <option value="title">Title A-Z</option>
                        <option value="-title">Title Z-A</option>
                        <option value="-duration">Longest First</option>
                        <option value="duration">Shortest First</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Toggle Advanced Filters -->
        <div class="mt-4">
            <button 
                id="toggle-filters" 
                class="text-primary-600 hover:text-primary-500 text-sm font-medium"
                onclick="toggleAdvancedFilters()"
            >
                Show Advanced Filters
            </button>
        </div>
    </div>
    
    <!-- Results Summary -->
    <div id="results-summary" class="mb-4 text-sm text-secondary-600">
        Loading content...
    </div>
    
    <!-- Content Grid -->
    <div id="content-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        <!-- Content will be loaded here -->
    </div>
    
    <!-- Pagination -->
    <div id="pagination" class="mt-8 flex justify-center">
        <!-- Pagination controls will be loaded here -->
    </div>
</div>

<!-- Content Detail Modal -->
<div id="content-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" onclick="closeModal()">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div id="modal-content">
                <!-- Content details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
let currentContentType = 'videos';
let currentPage = 1;
let isLoading = false;

// Initialize library
document.addEventListener('DOMContentLoaded', function() {
    loadContent();
    loadOwnerOptions();
});

// Load content based on current filters
async function loadContent(page = 1) {
    if (isLoading) return;
    
    isLoading = true;
    const loadingIndicator = document.getElementById('results-summary');
    loadingIndicator.innerHTML = '<div class="animate-pulse">Loading content...</div>';
    
    try {
        const params = new URLSearchParams();
        
        // Add search term
        const search = document.getElementById('search').value;
        if (search) params.append('search', search);
        
        // Add filters
        const filters = ['grade', 'topic', 'owner', 'ordering'];
        filters.forEach(filter => {
            const element = document.getElementById(filter + '-filter');
            if (element && element.value) {
                params.append(filter, element.value);
            }
        });
        
        // Add pagination
        params.append('page', page);
        params.append('page_size', '20');
        
        // Build API URL
        const apiUrl = `/api/library/${currentContentType}/?${params.toString()}`;
        
        const response = await fetch(apiUrl, {
            headers: {
                'Authorization': 'Bearer ' + getFirebaseToken(),
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        // Update results summary
        const totalResults = data.count || 0;
        const startResult = ((page - 1) * 20) + 1;
        const endResult = Math.min(page * 20, totalResults);
        
        loadingIndicator.innerHTML = `
            Showing ${startResult}-${endResult} of ${totalResults} results
            ${data.filters && data.filters.applied_filters ? 
                `<span class="ml-2 text-primary-600">(filtered)</span>` : ''
            }
        `;
        
        // Update content grid
        updateContentGrid(data.results || []);
        
        // Update pagination
        updatePagination(data, page);
        
        currentPage = page;
        
    } catch (error) {
        console.error('Failed to load content:', error);
        loadingIndicator.innerHTML = '<div class="text-red-600">Failed to load content. Please try again.</div>';
    } finally {
        isLoading = false;
    }
}

// Update content grid
function updateContentGrid(items) {
    const grid = document.getElementById('content-grid');
    
    if (items.length === 0) {
        grid.innerHTML = `
            <div class="col-span-full text-center py-12">
                <svg class="mx-auto h-12 w-12 text-secondary-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-secondary-900">No content found</h3>
                <p class="mt-1 text-sm text-secondary-500">Try adjusting your search or filters.</p>
            </div>
        `;
        return;
    }
    
    grid.innerHTML = items.map(item => createContentCard(item)).join('');
}

// Create content card HTML
function createContentCard(item) {
    const isVideo = currentContentType === 'videos';
    const isResource = currentContentType === 'resources';
    const isPlaylist = currentContentType === 'playlists';
    
    let typeIcon, typeColor, metadata;
    
    if (isVideo) {
        typeIcon = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path d="M2 6a2 2 0 012-2h6l2 2h6a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM8 9a1 1 0 000 2h4a1 1 0 100-2H8z"/>
        </svg>`;
        typeColor = 'text-blue-600 bg-blue-100';
        metadata = `
            <div class="text-xs text-secondary-500 mb-2">
                ${item.grade_display} • ${item.topic_display}
                ${item.duration_formatted ? ` • ${item.duration_formatted}` : ''}
            </div>
        `;
    } else if (isResource) {
        typeIcon = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"/>
        </svg>`;
        typeColor = 'text-green-600 bg-green-100';
        metadata = `
            <div class="text-xs text-secondary-500 mb-2">
                ${item.file_type_display}
                ${item.grade_display ? ` • ${item.grade_display}` : ''}
                ${item.file_size_formatted ? ` • ${item.file_size_formatted}` : ''}
            </div>
        `;
    } else {
        typeIcon = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"/>
        </svg>`;
        typeColor = 'text-purple-600 bg-purple-100';
        metadata = `
            <div class="text-xs text-secondary-500 mb-2">
                ${item.video_count || 0} videos • ${item.total_duration_formatted || '0:00'}
            </div>
        `;
    }
    
    return `
        <div class="bg-white rounded-lg shadow-sm border border-secondary-200 hover:shadow-md transition-shadow cursor-pointer"
             onclick="showContentDetail('${item.id}')">
            <div class="p-4">
                <div class="flex items-center mb-3">
                    <div class="flex-shrink-0 p-2 rounded-lg ${typeColor}">
                        ${typeIcon}
                    </div>
                    <div class="ml-3 flex-1 min-w-0">
                        <h3 class="text-sm font-medium text-secondary-900 truncate">${item.title}</h3>
                        <p class="text-xs text-secondary-500 truncate">by ${item.owner_name || 'Unknown'}</p>
                    </div>
                </div>
                
                ${metadata}
                
                <p class="text-sm text-secondary-600 line-clamp-2 mb-3">
                    ${item.description || 'No description available.'}
                </p>
                
                <div class="flex items-center justify-between text-xs text-secondary-500">
                    <span>${formatDate(item.created_at)}</span>
                    ${item.status ? `<span class="px-2 py-1 rounded-full text-xs ${getStatusColor(item.status)}">${item.status}</span>` : ''}
                </div>
            </div>
        </div>
    `;
}

// Update pagination
function updatePagination(data, currentPage) {
    const pagination = document.getElementById('pagination');
    
    if (!data.next && !data.previous) {
        pagination.innerHTML = '';
        return;
    }
    
    const totalPages = Math.ceil(data.count / 20);
    let paginationHTML = '<nav class="flex items-center space-x-2">';
    
    // Previous button
    if (data.previous) {
        paginationHTML += `
            <button onclick="loadContent(${currentPage - 1})" 
                    class="px-3 py-2 rounded-md text-sm font-medium text-secondary-700 bg-white border border-secondary-300 hover:bg-secondary-50">
                Previous
            </button>
        `;
    }
    
    // Page numbers (simplified)
    paginationHTML += `
        <span class="px-3 py-2 text-sm text-secondary-700">
            Page ${currentPage} of ${totalPages}
        </span>
    `;
    
    // Next button
    if (data.next) {
        paginationHTML += `
            <button onclick="loadContent(${currentPage + 1})" 
                    class="px-3 py-2 rounded-md text-sm font-medium text-secondary-700 bg-white border border-secondary-300 hover:bg-secondary-50">
                Next
            </button>
        `;
    }
    
    paginationHTML += '</nav>';
    pagination.innerHTML = paginationHTML;
}

// Content type switching
function filterContent() {
    const contentType = document.getElementById('content-type').value;
    if (contentType !== currentContentType) {
        currentContentType = contentType;
        currentPage = 1;
    }
    loadContent(1);
}

// Toggle advanced filters
function toggleAdvancedFilters() {
    const filters = document.getElementById('advanced-filters');
    const toggle = document.getElementById('toggle-filters');
    
    if (filters.classList.contains('hidden')) {
        filters.classList.remove('hidden');
        toggle.textContent = 'Hide Advanced Filters';
    } else {
        filters.classList.add('hidden');
        toggle.textContent = 'Show Advanced Filters';
    }
}

// Clear all filters
function clearFilters() {
    document.getElementById('search').value = '';
    document.getElementById('grade-filter').value = '';
    document.getElementById('topic-filter').value = '';
    document.getElementById('owner-filter').value = '';
    document.getElementById('sort-filter').value = '-created_at';
    loadContent(1);
}

// Apply quick filters
function applyFilter(type) {
    clearFilters();
    if (type === 'recent') {
        document.getElementById('sort-filter').value = '-created_at';
    } else if (type === 'popular') {
        // Would typically sort by view count
        document.getElementById('sort-filter').value = '-created_at';
    }
    loadContent(1);
}

// Show content detail modal
async function showContentDetail(id) {
    const modal = document.getElementById('content-modal');
    const modalContent = document.getElementById('modal-content');
    
    modalContent.innerHTML = '<div class="p-8 text-center">Loading...</div>';
    modal.classList.remove('hidden');
    
    try {
        const response = await fetch(`/api/library/${currentContentType}/${id}/`, {
            headers: {
                'Authorization': 'Bearer ' + getFirebaseToken(),
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const item = await response.json();
        modalContent.innerHTML = createDetailModal(item);
        
    } catch (error) {
        console.error('Failed to load content detail:', error);
        modalContent.innerHTML = '<div class="p-8 text-center text-red-600">Failed to load content details.</div>';
    }
}

// Create detail modal content
function createDetailModal(item) {
    const isVideo = currentContentType === 'videos';
    const isResource = currentContentType === 'resources';
    
    return `
        <div class="p-6">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-2xl font-bold text-secondary-900">${item.title}</h2>
                <button onclick="closeModal()" class="text-secondary-400 hover:text-secondary-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2">
                    ${isVideo ? `
                        <div class="aspect-video bg-secondary-100 rounded-lg mb-4 flex items-center justify-center">
                            <div class="text-center">
                                <svg class="mx-auto h-12 w-12 text-secondary-400 mb-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                    <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                                </svg>
                                <p class="text-secondary-600">Video Player</p>
                                <p class="text-xs text-secondary-500">Streaming from Firebase Storage</p>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="prose max-w-none">
                        <h3>Description</h3>
                        <p>${item.description || 'No description available.'}</p>
                        
                        ${item.tags && item.tags.length > 0 ? `
                            <h4>Tags</h4>
                            <div class="flex flex-wrap gap-2 not-prose">
                                ${item.tags.map(tag => `
                                    <span class="px-2 py-1 bg-primary-100 text-primary-800 rounded-full text-xs">${tag}</span>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div class="bg-secondary-50 rounded-lg p-4">
                        <h4 class="font-medium text-secondary-900 mb-2">Details</h4>
                        <dl class="space-y-2 text-sm">
                            <div>
                                <dt class="font-medium text-secondary-700">Created by</dt>
                                <dd class="text-secondary-600">${item.owner_name}</dd>
                            </div>
                            <div>
                                <dt class="font-medium text-secondary-700">School</dt>
                                <dd class="text-secondary-600">${item.school_name}</dd>
                            </div>
                            ${item.grade_display ? `
                                <div>
                                    <dt class="font-medium text-secondary-700">Grade Level</dt>
                                    <dd class="text-secondary-600">${item.grade_display}</dd>
                                </div>
                            ` : ''}
                            ${item.topic_display ? `
                                <div>
                                    <dt class="font-medium text-secondary-700">Topic</dt>
                                    <dd class="text-secondary-600">${item.topic_display}</dd>
                                </div>
                            ` : ''}
                            ${item.duration_formatted ? `
                                <div>
                                    <dt class="font-medium text-secondary-700">Duration</dt>
                                    <dd class="text-secondary-600">${item.duration_formatted}</dd>
                                </div>
                            ` : ''}
                            ${item.file_size_formatted ? `
                                <div>
                                    <dt class="font-medium text-secondary-700">File Size</dt>
                                    <dd class="text-secondary-600">${item.file_size_formatted}</dd>
                                </div>
                            ` : ''}
                            <div>
                                <dt class="font-medium text-secondary-700">Created</dt>
                                <dd class="text-secondary-600">${formatDate(item.created_at)}</dd>
                            </div>
                        </dl>
                    </div>
                    
                    <div class="space-y-2">
                        ${isResource ? `
                            <button onclick="downloadResource('${item.id}')" 
                                    class="btn btn-primary w-full">
                                Download Resource
                            </button>
                        ` : ''}
                        <button onclick="addToPlaylist('${item.id}')" 
                                class="btn btn-secondary w-full">
                            Add to Playlist
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Close modal
function closeModal() {
    document.getElementById('content-modal').classList.add('hidden');
}

// Download resource
async function downloadResource(resourceId) {
    try {
        const response = await fetch(`/api/resources/${resourceId}/download/`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + getFirebaseToken(),
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        window.open(data.download_url, '_blank');
        
    } catch (error) {
        console.error('Download failed:', error);
        alert('Failed to download resource. Please try again.');
    }
}

// Add to playlist (placeholder)
function addToPlaylist(itemId) {
    alert('Add to playlist functionality coming soon!');
}

// Load owner options for filter
async function loadOwnerOptions() {
    try {
        const response = await fetch('/api/library/stats/', {
            headers: {
                'Authorization': 'Bearer ' + getFirebaseToken(),
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            const ownerSelect = document.getElementById('owner-filter');
            
            data.active_teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.name;
                option.textContent = `${teacher.name} (${teacher.total_content} items)`;
                ownerSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Failed to load owner options:', error);
    }
}

// Utility functions
function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString();
}

function getStatusColor(status) {
    switch (status) {
        case 'PUBLISHED':
            return 'bg-green-100 text-green-800';
        case 'DRAFT':
            return 'bg-yellow-100 text-yellow-800';
        case 'PENDING':
            return 'bg-blue-100 text-blue-800';
        default:
            return 'bg-secondary-100 text-secondary-800';
    }
}

function getFirebaseToken() {
    // Placeholder - implement based on your Firebase auth setup
    return 'placeholder-token';
}
</script>

<style>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>
{% endblock %}

