{% extends 'base.html' %}

{% block title %}Teacher Dashboard - Fraction Ball LMS{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6">
    <!-- Welcome Header -->
    <div class="mb-8">
        <div id="welcome-header" class="bg-gradient-to-r from-primary-600 to-blue-600 rounded-lg p-6 text-white">
            <h1 class="text-3xl font-bold mb-2">Welcome back!</h1>
            <p class="text-primary-100">Here's what's happening in your classroom today.</p>
        </div>
    </div>
    
    <!-- Quick Stats -->
    <div id="quick-stats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Stats will be loaded here -->
    </div>
    
    <!-- Main Dashboard Content -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left Column -->
        <div class="lg:col-span-2 space-y-8">
            <!-- Recent Uploads -->
            <div class="card">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-secondary-900">Recent Uploads</h2>
                    <a href="/upload/" class="btn btn-primary text-sm">Upload New</a>
                </div>
                <div id="recent-uploads">
                    <!-- Recent uploads will be loaded here -->
                </div>
            </div>
            
            <!-- Popular Content -->
            <div class="card">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-secondary-900">Popular in Your School</h2>
                    <a href="/library/" class="text-primary-600 hover:text-primary-500 text-sm font-medium">Browse All</a>
                </div>
                <div id="popular-content">
                    <!-- Popular content will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Right Column -->
        <div class="space-y-8">
            <!-- My Playlists -->
            <div class="card">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-secondary-900">My Playlists</h2>
                    <button class="btn btn-secondary text-sm" onclick="createPlaylist()">Create New</button>
                </div>
                <div id="my-playlists">
                    <!-- Playlists will be loaded here -->
                </div>
            </div>
            
            <!-- Quick Links -->
            <div class="card">
                <h2 class="text-xl font-semibold text-secondary-900 mb-4">Quick Links</h2>
                <div id="quick-links" class="space-y-2">
                    <!-- Quick links will be loaded here -->
                </div>
            </div>
            
            <!-- School Activity -->
            <div class="card">
                <h2 class="text-xl font-semibold text-secondary-900 mb-4">Recent School Activity</h2>
                <div id="school-activity">
                    <!-- School activity will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
    <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mx-auto mb-4"></div>
        <p class="text-secondary-600">Loading your dashboard...</p>
    </div>
</div>

<script>
let dashboardData = null;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadDashboard();
});

// Load dashboard data
async function loadDashboard() {
    try {
        const response = await fetch('/api/dashboard/', {
            headers: {
                'Authorization': 'Bearer ' + getFirebaseToken(),
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        dashboardData = await response.json();
        renderDashboard();
        
    } catch (error) {
        console.error('Failed to load dashboard:', error);
        document.getElementById('loading-overlay').innerHTML = `
            <div class="text-center">
                <svg class="mx-auto h-12 w-12 text-red-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <p class="text-red-600">Failed to load dashboard</p>
                <button onclick="loadDashboard()" class="btn btn-primary mt-4">Try Again</button>
            </div>
        `;
    }
}

// Render dashboard components
function renderDashboard() {
    if (!dashboardData) return;
    
    // Update welcome header
    updateWelcomeHeader();
    
    // Render components
    renderQuickStats();
    renderRecentUploads();
    renderPopularContent();
    renderMyPlaylists();
    renderQuickLinks();
    renderSchoolActivity();
    
    // Hide loading overlay
    document.getElementById('loading-overlay').classList.add('hidden');
}

// Update welcome header
function updateWelcomeHeader() {
    const header = document.getElementById('welcome-header');
    const userInfo = dashboardData.user_info;
    
    header.innerHTML = `
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold mb-2">Welcome back, ${userInfo.name}!</h1>
                <p class="text-primary-100">${userInfo.role} at ${userInfo.school}</p>
            </div>
            <div class="text-right">
                <div class="text-2xl font-bold">${new Date().toLocaleDateString()}</div>
                <div class="text-primary-200 text-sm">${new Date().toLocaleDateString('en-US', { weekday: 'long' })}</div>
            </div>
        </div>
    `;
}

// Render quick stats
function renderQuickStats() {
    const stats = document.getElementById('quick-stats');
    const userStats = dashboardData.user_stats;
    const schoolStats = dashboardData.school_stats;
    
    stats.innerHTML = `
        <div class="card text-center">
            <div class="text-3xl font-bold text-primary-600 mb-2">${userStats.my_videos}</div>
            <div class="text-sm text-secondary-600">My Videos</div>
            <div class="text-xs text-green-600 mt-1">
                +${userStats.videos_uploaded_this_week} this week
            </div>
        </div>
        
        <div class="card text-center">
            <div class="text-3xl font-bold text-blue-600 mb-2">${userStats.my_resources}</div>
            <div class="text-sm text-secondary-600">My Resources</div>
        </div>
        
        <div class="card text-center">
            <div class="text-3xl font-bold text-purple-600 mb-2">${userStats.my_playlists}</div>
            <div class="text-sm text-secondary-600">My Playlists</div>
        </div>
        
        <div class="card text-center">
            <div class="text-3xl font-bold text-orange-600 mb-2">${schoolStats.total_videos}</div>
            <div class="text-sm text-secondary-600">School Videos</div>
            <div class="text-xs text-green-600 mt-1">
                +${schoolStats.videos_this_week} this week
            </div>
        </div>
    `;
}

// Render recent uploads
function renderRecentUploads() {
    const container = document.getElementById('recent-uploads');
    const uploads = dashboardData.recent_uploads;
    
    if (uploads.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8">
                <svg class="mx-auto h-12 w-12 text-secondary-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <h3 class="text-lg font-medium text-secondary-900 mb-2">No uploads yet</h3>
                <p class="text-secondary-500 mb-4">Start by uploading your first video or resource.</p>
                <a href="/upload/" class="btn btn-primary">Upload Content</a>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="space-y-3">
            ${uploads.map(upload => `
                <div class="flex items-center p-3 bg-secondary-50 rounded-lg hover:bg-secondary-100 transition-colors cursor-pointer"
                     onclick="viewContent('${upload.id}', 'video')">
                    <div class="flex-shrink-0 p-2 bg-blue-100 text-blue-600 rounded-lg">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2 6a2 2 0 012-2h6l2 2h6a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"/>
                        </svg>
                    </div>
                    <div class="ml-3 flex-1 min-w-0">
                        <p class="text-sm font-medium text-secondary-900 truncate">${upload.title}</p>
                        <p class="text-xs text-secondary-500">
                            ${upload.grade_display} • ${upload.topic_display} • ${formatDate(upload.created_at)}
                        </p>
                    </div>
                    <div class="flex-shrink-0">
                        <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(upload.status)}">${upload.status}</span>
                    </div>
                </div>
            `).join('')}
        </div>
        
        <div class="mt-4 text-center">
            <a href="/api/videos/" class="text-primary-600 hover:text-primary-500 text-sm font-medium">
                View All My Content →
            </a>
        </div>
    `;
}

// Render popular content
function renderPopularContent() {
    const container = document.getElementById('popular-content');
    const content = dashboardData.popular_content;
    
    if (content.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <p class="text-secondary-500">No popular content yet.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            ${content.slice(0, 4).map(item => `
                <div class="bg-secondary-50 rounded-lg p-4 hover:bg-secondary-100 transition-colors cursor-pointer"
                     onclick="viewContent('${item.id}', 'video')">
                    <h4 class="font-medium text-secondary-900 text-sm mb-1 truncate">${item.title}</h4>
                    <p class="text-xs text-secondary-500 mb-2">by ${item.owner_name}</p>
                    <div class="flex items-center justify-between text-xs text-secondary-500">
                        <span>${item.grade_display}</span>
                        <span>${item.duration_formatted || 'N/A'}</span>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

// Render my playlists
function renderMyPlaylists() {
    const container = document.getElementById('my-playlists');
    const playlists = dashboardData.my_playlists;
    
    if (playlists.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <svg class="mx-auto h-8 w-8 text-secondary-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
                <p class="text-secondary-500 text-sm mb-3">No playlists yet</p>
                <button onclick="createPlaylist()" class="btn btn-secondary text-sm">Create Your First Playlist</button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="space-y-3">
            ${playlists.map(playlist => `
                <div class="flex items-center justify-between p-3 bg-secondary-50 rounded-lg hover:bg-secondary-100 transition-colors cursor-pointer"
                     onclick="viewPlaylist('${playlist.id}')">
                    <div class="flex-1 min-w-0">
                        <h4 class="text-sm font-medium text-secondary-900 truncate">${playlist.name}</h4>
                        <p class="text-xs text-secondary-500">
                            ${playlist.video_count || 0} videos • ${playlist.total_duration_formatted || '0:00'}
                        </p>
                    </div>
                    <div class="flex-shrink-0">
                        <svg class="w-4 h-4 text-secondary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

// Render quick links
function renderQuickLinks() {
    const container = document.getElementById('quick-links');
    const links = dashboardData.quick_links;
    
    const defaultLinks = [
        { title: 'Browse Library', url: '/library/', description: 'Explore all available content' },
        { title: 'Upload Content', url: '/upload/', description: 'Add new videos and resources' },
        { title: 'Manage Content', url: '/api/videos/', description: 'Edit your uploaded content' }
    ];
    
    const allLinks = [...links, ...defaultLinks];
    
    container.innerHTML = allLinks.map(link => `
        <a href="${link.url}" class="block p-3 bg-secondary-50 rounded-lg hover:bg-primary-50 hover:border-primary-200 transition-colors border border-transparent">
            <div class="font-medium text-secondary-900 text-sm">${link.title}</div>
            <div class="text-xs text-secondary-500 mt-1">${link.description}</div>
        </a>
    `).join('');
}

// Render school activity
function renderSchoolActivity() {
    const container = document.getElementById('school-activity');
    const activity = dashboardData.recent_school_content;
    
    if (activity.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <p class="text-secondary-500 text-sm">No recent activity.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="space-y-3">
            ${activity.slice(0, 5).map(item => `
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0 w-2 h-2 bg-primary-400 rounded-full"></div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm text-secondary-900 truncate">${item.title}</p>
                        <p class="text-xs text-secondary-500">
                            by ${item.owner_name} • ${formatDate(item.created_at)}
                        </p>
                    </div>
                </div>
            `).join('')}
        </div>
        
        <div class="mt-4 text-center">
            <a href="/library/" class="text-primary-600 hover:text-primary-500 text-sm font-medium">
                View All Activity →
            </a>
        </div>
    `;
}

// Event handlers
function viewContent(id, type) {
    window.location.href = `/library/?content_type=${type}s&id=${id}`;
}

function viewPlaylist(id) {
    window.location.href = `/api/playlists/${id}/`;
}

function createPlaylist() {
    // Placeholder for playlist creation
    const name = prompt('Enter playlist name:');
    if (name) {
        alert('Playlist creation functionality coming soon!');
    }
}

// Utility functions
function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) {
        return 'Today';
    } else if (diffDays === 1) {
        return 'Yesterday';
    } else if (diffDays < 7) {
        return `${diffDays} days ago`;
    } else {
        return date.toLocaleDateString();
    }
}

function getStatusColor(status) {
    switch (status) {
        case 'PUBLISHED':
            return 'bg-green-100 text-green-800';
        case 'DRAFT':
            return 'bg-yellow-100 text-yellow-800';
        case 'PENDING':
            return 'bg-blue-100 text-blue-800';
        default:
            return 'bg-secondary-100 text-secondary-800';
    }
}

function getFirebaseToken() {
    // Placeholder - implement based on your Firebase auth setup
    return 'placeholder-token';
}
</script>
{% endblock %}

